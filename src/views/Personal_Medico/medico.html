<!--ya funciona el link que lleva aqui-->
<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Personal Médico</title>
        <link rel="stylesheet" href="../../styles/components.css">
        <!--nueva parte-->
         <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
            <script>
            (async () => {
                try {
                const response = await fetch('/api/supabase-config');
                const config = await response.json();
                
                window.supabase = window.supabase.createClient(config.url, config.anonKey);
                window.supabaseLoaded = true;
                console.log('Supabase inicializado desde servidor');
                } catch (e) {
                console.error('Error cargando config de Supabase:', e);
                window.supabaseLoaded = false;
                }
            })();
            </script>
    </head>
    <body>
        <!--header-->
        <div id="header-container"></div>
        <main>
            <div class="medico-bienvenida">
            <h1 id="titulo-area-medica"><h1 id="titulo-area-medica">Área de Personal Médico</h1>
            <p>Bienvenido al área de personal médico.</p><br>
            <div class="botones-medico">
            <button class="botonregreso" onclick="location.href='../sucursales/bienvenido.html'">Regresar</button>
            <!--revisar boton de agregar-->
            <button class="botonagregar" onclick="location.href='agregarmedico.html'">Agregar medico</button>
            <button id="btn-cerrar-sesion" class="botonregreso" aria-label="Cerrar sesión">Cerrar Sesión</button>
            </div>
            </div>
        <br>
            <div class="medico-personal">
                <h2>Medicos de la sucursal</h2>
               <table>
                <thead>
                <tr>
                    <th>Codigo</th>
                    <th>Curp</th>
                    <th>Nombre completo</th>
                    <th>Edad</th>
                    <th>Telefono</th>
                    <th>Direccion</th>
                    <th>Especialidad</th>
                    <th>Numero de sucursal</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody><!--quitar los ejemplos-->
            </tbody>
                </table>
            </div>
            <br>
        </main>
        <!--footer-->
        <div id="footer-container"></div>
       <!--cargar componentes-->
        <script>
            //cargar header
            fetch('../../../header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => console.error('Error al cargar el header:', error));
            //cargar footer
            fetch('../../../footer.html')
            .then(response => response.text())
            .then(data =>{
                document.getElementById('footer-container').innerHTML = data;
            })
            .catch(error => console.error('Error al cargar el footer:', error));
        </script>
        <script type="module" defer>
            //dios bendiceme con el script para que funcione
            //importar controlador
            import { MedicoController} from '/src/controllers/MedicoController.js';
            import { AuthController } from '/src/controllers/AuthController.js';

            if (!AuthController.verificarSesion() || !AuthController.verificarTipoUsuario('medico')) {
                window.location.href = '../Login/login.html';
            }

            //cargar medicos
            //document.addEventListener("DOMContentLoaded",cargarMedicos);
            cargarMedicos();
            //funcion para cargarlos
            async function cargarMedicos() {
            try{
                const numero_sucursal = localStorage.getItem("numero_sucursal");

            console.log("Numero sucursal:", numero_sucursal);
            //console.log("Respuesta servicio:", await MedicoController.obtenerMedicos(numero_sucursal))
                

                const {medicos,error} = await MedicoController.CargarMedicos();

                if(error){
                    console.error('Error cargando medicos',error);
                    return;
                }
                renderizarMedicos(medicos);
            }
            catch(error){
                console.error("Error:",error);
            }
            }
            //renderizar en tabla de medicos
            //chuy:tu puedes Alo no hay conocimiento pero hay fe hell yeah(alo:hahaha ;-;)
            function renderizarMedicos(medicos){
                const tbody = document.querySelector("tbody");
                tbody.innerHTML = "";//tabla limpia
                //si no hay medicos dice esto 
                if(!medicos || medicos.length === 0 ){
                tbody.innerHTML = `<tr><td colspan="9">No hay medicos en esta sucursal</td></tr>`;
                return;
                }
                medicos.forEach(medico => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = 
                    `<td>${medico.codigo}</td>
                     <td>${medico.curp}</td>
                     <td>${medico.nombre_completo}</td>
                     <td>${medico.edad}</td>
                     <td>${medico.telefono}</td>
                     <td>${medico.direccion}</td>
                     <td>${medico.especialidad}</td>
                     <td>${medico.numero_sucursal}</td>
                     <td>
                        <button class="citas-medico" data-codigo="${medico.codigo}" data-nombre_completo="${medico.nombre_completo}">Ver citas</button>
                        <button class="editar-medico" data-codigo="${medico.codigo}">Editar medico</button>
                        <button class="eliminar-medico" data-codigo="${medico.codigo}">Eliminar Medico</button>
                    </td>
                    `;
                    tbody.appendChild(tr);
                });
                activarBotones();
            }
            //pa que funcionen mis botoncitos preciosos
            function activarBotones(){
                //botoncito para ir a citas
                document.querySelectorAll(".citas-medico").forEach(btn => {
                    btn.addEventListener("click", () => {
                        localStorage.setItem("codigo_medico",btn.dataset.codigo);
                        localStorage.setItem("nombre_completo",btn.dataset.nombre_completo);
                        location.href = "citas-medico.html";
                    });
                });
                //botoncito para ir a editar
                document.querySelectorAll(".editar-medico").forEach(btn => {
                    btn.addEventListener("click", () => { 
                        localStorage.setItem("codigo_medico",btn.dataset.codigo);
                        location.href = "editarmedico.html";
                    });

                });
                //botoncito para eliminar(con confirmacion porque los errores existen)
                document.querySelectorAll(".eliminar-medico").forEach(btn => {
                btn.addEventListener("click", async () => {

                const codigo = btn.dataset.codigo;

                if (!confirm("¿Segurísima que quieres borrar?")) return;

                const { success, error } = await MedicoController.eliminarMedico(codigo);

                if (success) {
                alert("Se eliminó el médico");
                cargarMedicos();
                } else {
                alert("No se pudo eliminar");
                }
                });
                });
            }
            /*window.addEventListener('DOMContentLoaded', () => {
            const sucursalNombre = localStorage.getItem('sucursalNombre') || 'Sucursal';
            const titulo = document.getElementById('titulo-area-medica');
            if (titulo) {
            titulo.textContent = `Área de Personal Médico ${sucursalNombre}`;
            }
            });*/
            const sucursalNombre = localStorage.getItem('sucursalNombre') || 'Sucursal';
            const titulo = document.getElementById('titulo-area-medica');
            if (titulo) {
                titulo.textContent = `Área de Personal Médico ${sucursalNombre}`;
            }


            const btnCerrarSesion = document.getElementById('btn-cerrar-sesion');
            if (btnCerrarSesion) {
                btnCerrarSesion.addEventListener('click', () => {
                    AuthController.cerrarSesion();
                });
            }
        </script>
    </body>
</html>