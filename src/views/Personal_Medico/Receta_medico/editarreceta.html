<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Receta</title>
    <link rel="stylesheet" href="../../../styles/components.css">
</head>
<body>
    <div id="header-container"></div>
    
    <main class="mainn">
        <div class="bienvenida-medicoo">
            <h2>Editar Receta</h2>
            <button onclick="location.href='../citas-medico.html'">Regresar</button>
        </div>
        
        <div class="contenido-medico">
            <form id="formReceta">
                <input type="hidden" id="id-cita" name="id_cita">
                
                <h3>Agregar Medicamento</h3>
                
                <div id="medicamentos-container">
                <div class="medicamento-item">
                    
                    <label>Medicamento
                        <select class="select-medicamento" required>
                            <option value="">Cargando medicamentos...</option>
                        </select>
                    </label>

                    <label>Cantidad
                        <input type="number" class="input-cantidad" min="1" value="1" required>
                    </label>

                    <label>Dosis (opcional)
                        <input type="text" class="input-dosis" placeholder="Ej: 500mg cada 8 horas">
                    </label>

                    <button type="button" class="btn remove-med">Eliminar</button>
                    </div>
                 </div>

            <button type="button" id="add-medicamento" class="btn primary">
                + Agregar otro medicamento
            </button>
                
                <div style="margin-top: 20px;">
                    <button type="submit" class="btn primary">Guardar Receta</button>
                    <button type="button" onclick="location.href='verreceta.html'" class="btn">Cancelar</button>
                </div>
            </form>
        </div>
    </main>
    
    <div id="footer-container"></div>

<script type="module">
import { RecetaController } from '../../../controllers/RecetaController.js';


//document.addEventListener('DOMContentLoaded', async () => {
(async function () {

    // Obtener id de cita desde la URL
    const urlParams = new URLSearchParams(window.location.search);
    const idCita = urlParams.get('id_cita');

    if (!idCita) {
        alert('No se encontró ID de cita');
        location.href = '../citas-medico.html';
        return;
    }

    document.getElementById('id-cita').value = idCita;

    // ==========================================
    // 1. Cargar medicamentos disponibles
    // ==========================================
    let listaMedicamentos = [];
    const { medicamentos, error: errorMed } = await RecetaController.cargarMedicamentos();

    if (errorMed || !medicamentos) {
        alert("Error cargando lista de medicamentos");
        console.error(errorMed);
        return;
    }

    listaMedicamentos = medicamentos;


    // ==========================================
    // 2. Cargar receta existente (si existe)
    // ==========================================
    const { receta, error: errorRec } = await RecetaController.obtenerRecetaporCita(idCita);

    if (!errorRec && receta) {
        console.log("Receta encontrada:", receta);
        cargarMedicamentosExistentes(receta.receta_medicamento);
    }


    // ==========================================
    // FUNCIONES
    // ==========================================

    function cargarSelects() {
    const selects = document.querySelectorAll(".select-medicamento");

    selects.forEach(select => {
        const valorPrevio = select.value; // <--- GUARDAR SELECCIÓN

        select.innerHTML = '<option value="">Seleccione un medicamento...</option>';

        listaMedicamentos.forEach(med => {
            const option = document.createElement("option");
            option.value = med.id_medicamento;
            option.textContent = `${med.nombre} - $${med.precio}`;
            select.appendChild(option);
        });

        // VOLVER A SELECCIONAR EL VALOR ANTERIOR (si existía)
        if (valorPrevio) {
            select.value = valorPrevio;
        }
    });
}

    function cargarMedicamentosExistentes(lista) {
        const container = document.getElementById("medicamentos-container");
        container.innerHTML = "";

        lista.forEach(item => {
            const div = document.createElement("div");
            div.classList.add("medicamento-item");
            div.dataset.idReceta = item.id_receta;
div.dataset.idMedicamento = item.id_medicamento;

            div.innerHTML = `
                <label>Medicamento
                    <select class="select-medicamento" required>
                        <option value="">Cargando...</option>
                    </select>
                </label>

                <label>Cantidad
                    <input type="number" class="input-cantidad" min="1" value="${item.cantidad}" required>
                </label>

                <label>Dosis (opcional)
                    <input type="text" class="input-dosis" value="${item.dosis || ''}">
                </label>

                <button type="button" class="btn remove-med">Eliminar</button>
            `;

            container.appendChild(div);
        });

        cargarSelects();

        setTimeout(() => {
            const selects = document.querySelectorAll(".select-medicamento");
            selects.forEach((sel, i) => {
                sel.value = lista[i].id_medicamento;
            });
        }, 200);
    }


    // ==========================================
    // 3. Agregar nuevo medicamento
    // ==========================================
    document.getElementById("add-medicamento").addEventListener("click", () => {
        const container = document.getElementById("medicamentos-container");

        const block = document.createElement("div");
        block.classList.add("medicamento-item");

        block.innerHTML = `
            <label>Medicamento
                <select class="select-medicamento" required></select>
            </label>

            <label>Cantidad
                <input type="number" class="input-cantidad" value="1" min="1" required>
            </label>

            <label>Dosis (opcional)
                <input type="text" class="input-dosis">
            </label>

            <button type="button" class="btn remove-med">Eliminar</button>
        `;

        container.appendChild(block);
        cargarSelects();
    });


    // ==========================================
    // 4. Eliminar bloque visual (marca para borrar)
    // ==========================================
    document.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-med")) {

            const div = e.target.closest(".medicamento-item");

            // marcar como eliminado si ya existía
          if (div.dataset.idMedicamento) {
                div.classList.add("to-delete");
                div.style.display = "none"; // ocultarlo sin borrarlo
            } else {
                div.remove(); // solo los que no existen en la BD se pueden borrar directo
            }


        }
    });


    // ==========================================
// 5. ENVIAR FORMULARIO (Actualizar Receta)
// ==========================================
document.getElementById('formReceta').addEventListener('submit', async (e) => {
    e.preventDefault();

    const idCita = parseInt(document.getElementById('id-cita').value);

    // 1. Buscar receta existente
    let { receta, error: errBuscar } = await RecetaController.obtenerRecetaporCita(idCita);

    // 2. Si NO existe, crearla
    if (!receta) {
        let resultadoCreacion = await RecetaController.crearRecetaDesdeCita(idCita);

        if (resultadoCreacion.error) {
            alert("Error al obtener/crear receta");
            return;
        }

        receta = resultadoCreacion.receta;
    }

    // ===========================
    // 3. ELIMINAR PRIMERO
    // ===========================
    const toDelete = document.querySelectorAll(".to-delete");

    for (const node of toDelete) {
        const idReceta = node.dataset.idReceta;
        const idMedicamento = node.dataset.idMedicamento;

        if (idReceta && idMedicamento) {
            await RecetaController.eliminarMedicamentoReceta(idReceta, idMedicamento);
        }
    }

    // ===========================
    // 4. LUEGO AGREGAR/ACTUALIZAR
    // ===========================
    const bloques = document.querySelectorAll(".medicamento-item");

    for (const item of bloques) {

        const idRecetaExistente = item.dataset.idReceta;          // existe si viene de la BD
        const idMedicamentoExistente = item.dataset.idMedicamento; // existe si viene de la BD

        const idMedicamento = item.querySelector(".select-medicamento").value;
        const cantidad = item.querySelector(".input-cantidad").value;
        const dosis = item.querySelector(".input-dosis").value;

        if (!idMedicamento) continue; // evitar guardar vacíos

        if (idRecetaExistente && idMedicamentoExistente) {
            // actualizar
            await RecetaController.actualizarMedicamentoReceta(
                idRecetaExistente,
                idMedicamentoExistente,
                {
                    id_medicamento: idMedicamento,
                    cantidad,
                    dosis
                }
            );
        } else {
            // agregar nuevo
            await RecetaController.agregarMedicamentoAReceta(receta.id_receta, {
                id_medicamento: idMedicamento,
                cantidad,
                dosis,
                comprado: false
            });
        }
    }

    alert("Receta actualizada correctamente");
    location.href = "verreceta.html";
});
})();

// Header
fetch('../../../../header.html')
    .then(res => res.text())
    .then(data => document.getElementById('header-container').innerHTML = data);

// Footer
fetch('../../../../footer.html')
    .then(res => res.text())
    .then(data => document.getElementById('footer-container').innerHTML = data);

</script>
</body>
</html>