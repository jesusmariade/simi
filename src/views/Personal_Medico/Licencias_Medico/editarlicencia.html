<!--me arruinaron mi link, src/views/Personal_Medico/Licencias_Medico/editarlicencia.html-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editar Licencia</title>
    <link rel="stylesheet" href="../../../styles/components.css">
</head>
<body>
    <div id="header-container"></div>
    <main>
            <div class="titulo-soli-licencia">
                <h2>Editar Licencia M√©dica</h2>
            </div>
                <div class="licencia-medico">
                <form id="form-licencia">
                    <!--Inicio-->
                    <div class="inicio-licencia">
                    <label for="fecha_inicio">Fecha de Inicio:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" required>
                    </div>
                    <!--Fin-->
                    <div class="fin-licencia">
                    <label for="fecha_fin">Fecha de Fin:</label>
                   <input type="date" id="fecha_fin" name="fecha_fin" required><br><br>
                    </div>
                    <!--D√≠as-->
                    <div class="duracion-licencia">
                    <label for="duracion_dias">Total de D√≠as</label><br>
                    <input type="number" id="duracion_dias" name="duracion_dias" required>
                    <div>
                        <div class="botones-medico">
                            <button type="submit" class="actualizar-medico">Guardar Cambios</button>
                            <button onclick="location.href='/src/views/Personal_Medico/citas-medico.html'" class="cancelar-medico">Cancelar</button>
                        </div>
                </div>
    </main>
    <div id="footer-container"></div>

<script type="module">
import { LicenciaController } from '../../../controllers/LicenciaController.js';

(async function () {

    const id_licencia = localStorage.getItem("id_licencia");

    if (!id_licencia) {
        console.error("No se encontr√≥ id_licencia");
        return;
    }

    const fechainicioInput = document.getElementById("fecha_inicio");
    const fechafinInput = document.getElementById("fecha_fin");
    const diasInput = document.getElementById("duracion_dias");
    const form = document.getElementById("form-licencia");

    // Cargar licencia existente
    const { licencia, error } = await LicenciaController.CargarLicenciaPorID(id_licencia);

    if (error || !licencia) {
        console.error("Error al traer licencia", error);
        return;
    }

    fechainicioInput.value = licencia.fecha_inicio;
    fechafinInput.value = licencia.fecha_fin;
    diasInput.value = licencia.duracion_dias;

    // Calculador autom√°tico
    function calcularduracion() {
        const inicio = new Date(fechainicioInput.value);
        const fin = new Date(fechafinInput.value);

        if (!fechainicioInput.value || !fechafinInput.value) {
            diasInput.value = "";
            return;
        }

        if (fin < inicio) {
            alert("La fecha de fin no puede ser menor a la fecha de inicio");
            fechafinInput.value = "";
            diasInput.value = "";
            return;
        }

        const diffTime = fin - inicio;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

        if (diffDays > 15) {
            alert("Las licencias no pueden exceder los 15 d√≠as");
            fechafinInput.value = "";
            diasInput.value = "";
            return;
        }

        diasInput.value = diffDays;
    }

    fechainicioInput.addEventListener("change", calcularduracion);
    fechafinInput.addEventListener("change", calcularduracion);

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (!diasInput.value || diasInput.value <= 0) {
            alert("Por favor revisa las fechas, no se pudo calcular la duraci√≥n");
            return;
        }

        const licenciaActualizada = {
            fecha_inicio: fechainicioInput.value,
            fecha_fin: fechafinInput.value,
            duracion_dias: diasInput.value
        };

        const { licencia: resultado, error } = await LicenciaController.actualizarLicencia(
            id_licencia,
            licenciaActualizada
        );

        if (error) {
            alert("No se pudo actualizar la licencia");
            console.error("Error", error);
            return;
        }

        alert("Licencia actualizada correctamente üòé");
        window.location.href = "/src/views/Personal_Medico/citas-medico.html";
    });

})();
</script>
    <script>
        //cargar header
        fetch('../../../../header.html')
        .then(response => response.text())
        .then(data =>{
            document.getElementById('header-container').innerHTML = data;
        })
        .catch(error => console.error('No se pudo cargar el header', error));
        //cargar footer
        fetch('../../../../footer.html')
        .then(response => response.text())
        .then(data => {
            document.getElementById('footer-container').innerHTML = data;
        })
        .catch(error => console.error('No cargo el footer', error));
    </script>
</body>
</html>