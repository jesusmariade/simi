<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Solicitar Licencia</title>
        <link rel="stylesheet" href="../../../styles/components.css">
         <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
    <script>
      (async () => {
        try {
          const response = await fetch('/api/supabase-config');
          const config = await response.json();
          
          window.supabase = window.supabase.createClient(config.url, config.anonKey);
          window.supabaseLoaded = true;
          console.log('Supabase inicializado desde servidor');
        } catch (e) {
          console.error('Error cargando config de Supabase:', e);
          window.supabaseLoaded = false;
        }
      })();
    </script>
    </head>
    <body>
        <div id="header-container"></div>
        <main>
            <div class="titulo-soli-licencia">
                <h2>Solicitar Licencia Médica</h2>
            </div>
                <div class="licencia-medico">
                <form id="form-licencia">
                    <!--Inicio-->
                    <div class="inicio-licencia">
                    <label for="fecha_inicio">Fecha de Inicio:</label>
                    <input type="date" id="fecha_inicio" name="fecha_inicio" required><br><br>
                    </div>
                    <!--Fin-->
                    <div class="fin-licencia">
                    <label for="fecha_fin">Fecha de Fin:</label>
                    <input type="date" id="fecha_fin" name="fecha_fin" required><br><br>
                    </div>
                    <!--Días-->
                    <div class="duracion-licencia">
                    <label for="duracion_dias">Total de Días</label><br>
                    <input type="number" id="duracion_dias" name="duracion_dias" rows="4" cols="50" required><br><br>
                    </div>
                        <div class="botones-medico">
                            <button class="cancelar-medico" type='submit'>Agregar</button>
                            <button onclick="location.href='/src/views/Personal_Medico/citas-medico.html'" class="cancelar-medico">Cancelar</button>
                        </div>
                </form>
                </div>
        </main>
        <!--footer-->
        <div id="footer-container"></div>
       <!--cargar componentes-->
        <script type="module">
            const codigo_medico = localStorage.getItem("codigo_medico");
            //COSOS DEL CONTROLLER JEJEJEJE
            import { LicenciaController } from '../../../controllers/LicenciaController.js';

            const form = document.getElementById("form-licencia");
            const fechainicioInput = document.getElementById("fecha_inicio");
            const fechafinInput = document.getElementById("fecha_fin");
            const diasInput = document.getElementById("duracion_dias")

            //calcular dias que durara la licencia automaticamente
            function calcularduracion(){
                const inicio = new Date(fechainicioInput.value);
                const fin = new Date(fechafinInput.value);

                if(!fechainicioInput.value || !fechafinInput.value){
                    diasInput.value = "";
                    return;
                }
                if(fin<inicio){
                    alert("La fecha de fin no puede ser mayor a la fecha de inicio");
                    fechafinInput.value = "";
                    diasInput.value = "";
                    return;
                }
                //diferencia de dias
                const diffTime = fin - inicio;
                const diffDays =  Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;

                if(diffDays > 15){
                    alert("Las licencias no pueden exceder los 15 dias, pillin");
                    fechafinInput.value = "";
                    diasInput.value = "";
                    return;
                }
                diasInput.value = diffDays;
            }
            fechainicioInput.addEventListener('change',calcularduracion);
            fechafinInput.addEventListener('change',calcularduracion);

            
            form.addEventListener("submit", async (e) => {
                e.preventDefault();

                //si no hay duracion valida
                if(!diasInput.value || diasInput.value <= 0 ){
                    alert("Por favor revisa las fechas, no se pudo calcular duracion");
                    return;
                }

                const licenciaData = {
                    codigo_medico: localStorage.getItem("codigo_medico"),
                    fecha_inicio: fechainicioInput.value,
                    fecha_fin: fechafinInput.value,
                    duracion_dias: diasInput.value,
                };

                console.log("Datos que se envían a Supabase:", licenciaData);


                const { licencia, error} = await LicenciaController.CrearLicencia(licenciaData);

                if(error) {
                    alert("No se pudo añadir la licencia womp womp");
                    console.error("Error al crear la licencia", error);
                    return;
                }
                alert("Licencia agregada exitosamente disfruta tus vacaciones locogod :p");
                window.location.href = "../citas-medico.html";
            })
        </script>
        <script>
            //cargar header
            fetch('../../../../header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-container').innerHTML = data;
            })
            .catch(error => console.error('Error al cargar el header:', error));
            //cargar footer
            fetch('../../../../footer.html')
            .then(response => response.text())
            .then(data =>{
                document.getElementById('footer-container').innerHTML = data;
            })
            .catch(error => console.error('Error al cargar el footer:', error));
        </script>
    </body>
</html>